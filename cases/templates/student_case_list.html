{% extends "base.html" %}
{% load static %}

{% block title %}Case Studies{% endblock %}

{% block content %}
<div class="container py-5">

    <!-- Header -->
    <div class="text-center mb-5">
        <h1 class="fw-bold display-5" style="color: var(--primary-color);">Case Studies</h1>
        <p class="text-muted fs-5">Explore approved medical case studies for your academic level.</p>
    </div>

    <!-- Filters -->
    <form method="get" class="row g-3 mb-5">
        <div class="col-md-4">
            <input type="text" name="search" class="form-control form-control-lg"
                   placeholder="Search case study..." value="{{ request.GET.search }}">
        </div>

        <div class="col-md-4">
            <select name="discipline" class="form-select form-select-lg">
                <option value="all">All Disciplines</option>
                <option value="internal" {% if selected_discipline == "internal" %}selected{% endif %}>Internal Medicine</option>
                <option value="surgery" {% if selected_discipline == "surgery" %}selected{% endif %}>Surgery</option>
                <option value="pediatrics" {% if selected_discipline == "pediatrics" %}selected{% endif %}>Pediatrics</option>
                <option value="obgyn" {% if selected_discipline == "obgyn" %}selected{% endif %}>OB/GYN</option>
                <option value="dermatology" {% if selected_discipline == "dermatology" %}selected{% endif %}>Dermatology</option>
                <option value="other" {% if selected_discipline == "other" %}selected{% endif %}>Other</option>
            </select>
        </div>

        <div class="col-md-4">
            <button class="btn btn-primary btn-lg w-100 shadow-sm">Filter</button>
        </div>
    </form>

    <!-- Case Studies Grid -->
    <div class="row g-4">
        {% for case in cases %}
        <div class="col-md-4 col-sm-6 mb-4">
            <div class="card h-100 shadow-sm border-0 rounded-4 overflow-hidden hover-scale"
                 style="background-color: white;">

                <!-- Image or Thumbnail -->
                {% if case.thumbnail %}
                    <img src="{{ case.thumbnail.url }}" class="card-img-top card-img-hover" style="height: 220px; object-fit: cover;">
                {% elif case.image_file %}
                    <img src="{{ case.image_file.url }}" class="card-img-top card-img-hover" style="height: 220px; object-fit: cover;">
                {% else %}
                    <img src="{% static 'images/no-image.png' %}" class="card-img-top card-img-hover" style="height: 220px; object-fit: cover;">
                {% endif %}

                <div class="card-body d-flex flex-column p-4">

                    <h5 class="fw-bold mb-2" style="color: var(--primary-color);">{{ case.title }}</h5>

                    <p class="text-muted small mb-2">
                        {{ case.get_discipline_display }} • Level: {{ case.target_level }}
                    </p>

                    <p class="small mb-3 text-secondary">
                        <i class="bi bi-calendar me-1"></i> {{ case.session_date }} &nbsp;
                        <i class="bi bi-clock me-1"></i> {{ case.session_time }}
                    </p>

                    <!-- Badges -->
                    <div class="mb-3 d-flex flex-wrap align-items-center gap-2">
                        <span class="badge 
                            {% if case.approval_status == 'draft' %} bg-secondary
                            {% elif case.approval_status == 'pending' %} bg-warning text-dark
                            {% elif case.approval_status == 'approved' %} bg-success
                            {% elif case.approval_status == 'rejected' %} bg-danger
                            {% endif %} me-1">
                            {{ case.get_approval_status_display }}
                        </span>

                        {% if case.is_paid %}
                            <span class="badge bg-primary">Price: ${{ case.price }}</span>
                        {% else %}
                            <span class="badge bg-success">Free</span>
                        {% endif %}
                    </div>

                    <!-- Action Buttons -->
                    <div class="mt-auto d-grid gap-2">
                        {% if case.pdf_file %}
                        <a href="{{ case.pdf_file.url }}" class="btn btn-outline-secondary btn-sm" style="border-radius: var(--radius);">
                            View PDF
                        </a>
                        {% endif %}

                        {# Join Zoom يظهر فقط إذا الحالة مجانية أو تم شراءها مسبقًا #}
                        {% if not case.is_paid or case.user_has_paid %}
                        <a href="{{ case.zoom_link }}" target="_blank" class="btn btn-outline-info btn-sm" style="border-radius: var(--radius);">
                            Join Zoom
                        </a>
                        {% endif %}

                        <a href="{% url 'cases_new:student_detail' case.pk %}" 
                           class="btn btn-outline-primary btn-sm" style="border-radius: var(--radius);">
                            View Case
                        </a>

                        {% if case.is_paid and not case.user_has_paid %}
                            <a href="#" class="btn btn-accent-pill btn-sm">
                                Buy Now
                            </a>
                        {% endif %}
                    </div>

                </div>
            </div>
        </div>
        {% empty %}
        <div class="col-12 text-center text-muted py-5">
            <h5>No case studies found.</h5>
        </div>
        {% endfor %}
    </div>

</div>

<!-- Custom Hover Styles -->
<style>
.card-img-hover {
    transition: transform 0.3s ease;
}
.card-img-hover:hover {
    transform: scale(1.05);
}
.hover-scale {
    transition: transform 0.3s ease, box-shadow 0.3s ease;
}
.hover-scale:hover {
    transform: translateY(-5px);
    box-shadow: 0 10px 25px rgba(0,0,0,0.15);
}
</style>
{% endblock %}
