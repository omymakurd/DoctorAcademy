{% extends "dashboards/instructor_base.html" %}
{% load static %}

{% block content %}
<div class="container py-4">
    <h2>Manage Case Studies</h2>

    <!-- زر إنشاء حالة جديدة -->
    <button type="button" class="btn btn-primary mb-3" data-bs-toggle="modal" data-bs-target="#createCaseModal">
        + Create New Case
    </button>

    <!-- جدول الحالات -->
    <table class="table table-striped" id="casesTable">
        <thead>
            <tr>
                <th>Title</th>
                <th>Discipline</th>
                <th>Level</th>
                <th>Session Date</th>
                <th>Status</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody>
            {% for case in cases %}
            <tr id="caseRow{{ case.id }}">
                <td>{{ case.title }}</td>
                <td>{{ case.discipline }}</td>
                <td>{{ case.target_level }}</td>
                <td>{{ case.session_date }}</td>
                <td>{{ case.approval_status }}</td>
                <td>
                    <a href="{% url 'cases_new:edit' case.id %}" class="btn btn-sm btn-outline-primary">Edit</a>
                    <button class="btn btn-sm btn-outline-secondary view-case-btn" data-url="{% url 'cases_new:detail' case.id %}">View</button>
                    <button class="btn btn-sm btn-outline-danger delete-case-btn" data-id="{{ case.id }}">Delete</button>
                </td>
            </tr>
            {% empty %}
            <tr id="noCasesRow">
                <td colspan="6" class="text-center">No cases found.</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

<!-- مودال Create / Edit / View -->
<div class="modal fade" id="createCaseModal" tabindex="-1" aria-labelledby="createCaseModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="createCaseModalLabel">Case Study</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body" id="modalCaseBody">
        <div class="text-center">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %}


{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {

    const casesTable = document.getElementById('casesTable').querySelector('tbody');
    const modalElement = document.getElementById('createCaseModal');
    const modal = new bootstrap.Modal(modalElement);
    const modalBody = document.getElementById('modalCaseBody');

    // ========= Create =========
    document.querySelector('[data-bs-target="#createCaseModal"]').addEventListener('click', function() {
        modalBody.innerHTML = loadingHtml();
        fetch("{% url 'cases_new:create' %}")
        .then(r => r.text())
        .then(html => {
            modalBody.innerHTML = html;
            handleFormSubmit();    // ← الآن الفوم موجود
        });
    });

    // ========= Edit =========
    casesTable.addEventListener('click', function(e) {
        if(e.target && e.target.matches('a.btn-outline-primary')) {
            e.preventDefault();
            const editUrl = e.target.getAttribute('href');

            modalBody.innerHTML = loadingHtml();
            fetch(editUrl)
            .then(r => r.text())
            .then(html => {
                modalBody.innerHTML = html;
                modal.show();
                handleFormSubmit();   // ← الآن فقط
            });
        }
    });

    // ========= View =========
    casesTable.addEventListener('click', function(e) {
        if(e.target && e.target.classList.contains('view-case-btn')) {
            const viewUrl = e.target.getAttribute('data-url');
            modalBody.innerHTML = loadingHtml();
            fetch(viewUrl)
            .then(r => r.text())
            .then(html => {
                modalBody.innerHTML = html;
                modal.show();
            });
        }
    });

    // ========= Delete =========
    casesTable.addEventListener('click', function(e) {
        if(e.target && e.target.classList.contains('delete-case-btn')) {
            const caseId = e.target.getAttribute('data-id');

            if(confirm('Are you sure you want to delete this case study?')) {
                const url = "{% url 'cases_new:delete' 0 %}".replace('0', caseId);

                fetch(url, {
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': '{{ csrf_token }}',
                        'X-Requested-With': 'XMLHttpRequest'
                    }
                })
                .then(r => r.json())
                .then(data => {
                    if(data.success) {
                        document.getElementById(`caseRow${caseId}`)?.remove();
                        if(casesTable.children.length === 0){
                            casesTable.innerHTML = `<tr id="noCasesRow">
                                <td colspan="6" class="text-center">No cases found.</td>
                            </tr>`;
                        }
                    }
                });
            }
        }
    });

    // ========= Form Submit =========
    function handleFormSubmit() {

        const form = modalBody.querySelector("form");
        if(!form) return;

        form.addEventListener('submit', function(e) {
            e.preventDefault();

            const formData = new FormData(form);

            fetch(form.action, {
                method: form.method,
                body: formData,
                headers: {'X-Requested-With': 'XMLHttpRequest'}
            })
            .then(r => r.json())
            .then(data => {

                if(data.success){

                    modal.hide();

                    const rowId = `caseRow${data.case.id}`;
                    const existingRow = document.getElementById(rowId);

                    const rowHtml = `
                        <td>${data.case.title}</td>
                        <td>${data.case.discipline}</td>
                        <td>${data.case.target_level}</td>
                        <td>${data.case.session_date}</td>
                        <td>${data.case.approval_status}</td>
                        <td>
                            <a href="${data.case.edit_url}" class="btn btn-sm btn-outline-primary">Edit</a>
                            <button class="btn btn-sm btn-outline-secondary view-case-btn" data-url="${data.case.detail_url}">View</button>
                            <button class="btn btn-sm btn-outline-danger delete-case-btn" data-id="${data.case.id}">Delete</button>
                        </td>
                    `;

                    if(existingRow){
                        existingRow.innerHTML = rowHtml;   // ← تعديل الصف
                    } 
                    else {
                        const newRow = document.createElement('tr');
                        newRow.id = rowId;
                        newRow.innerHTML = rowHtml;

                        const noCasesRow = document.getElementById('noCasesRow');
                        if(noCasesRow) noCasesRow.remove();

                        casesTable.prepend(newRow);
                    }

                } else {
                    modalBody.innerHTML = data.html_form;
                    handleFormSubmit();   // ← إعادة ربط الحدث
                }
            });
        });
    }

    function loadingHtml() {
        return `
        <div class="text-center py-4">
            <div class="spinner-border text-primary"></div>
        </div>`;
    }

});
</script>
{% endblock %}


