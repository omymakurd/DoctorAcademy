{% extends "base.html" %}
{% load static %}
{% load custom_tags %}
{% load get_item %}

{% block content %}
<div class="container py-5">

  <!-- Profile Header -->
 <div class="text-center mb-4 position-relative">
    {% comment %} اختر أول صورة متاحة لأي بروفايل {% endcomment %}
    {% if user.instructor_profile and user.instructor_profile.photo %}
        {% with photo_url=user.instructor_profile.photo.url %}
            <img id="profile-photo" src="{{ photo_url }}" class="rounded-circle mb-3 shadow-sm" width="120" height="120">
        {% endwith %}
    {% elif user.provider_profile and user.provider_profile.photo %}
        {% with photo_url=user.provider_profile.photo.url %}
            <img id="profile-photo" src="{{ photo_url }}" class="rounded-circle mb-3 shadow-sm" width="120" height="120">
        {% endwith %}
    {% else %}
        {% with photo_url="https://ui-avatars.com/api/?name="|add:user.get_full_name|default:user.username|add:"&background=0D6EFD&color=fff&size=120" %}
            <img id="profile-photo" src="{{ photo_url }}" class="rounded-circle mb-3 shadow-sm" width="120" height="120">
        {% endwith %}
    {% endif %}

    <input type="file" id="photo-input" style="position:absolute; bottom:0; left:50%; transform:translateX(-50%); opacity:0; width:120px; height:120px; cursor:pointer;">
    <label for="photo-input" style="position:absolute; bottom:0; left:50%; transform:translateX(-50%); cursor:pointer; background:#0d6efd; color:white; padding:2px 8px; border-radius:5px;">Change</label>
</div>

  <!-- Account Information Card -->
  <div class="card shadow-sm border-0 mb-4">
    <div class="card-header bg-white fw-bold">Account Information</div>
    <div class="card-body px-4 py-3">
      {% for item in account_fields %}
        <div class="row mb-2">
          <div class="col-sm-4 fw-semibold text-muted" data-bs-toggle="tooltip" title="{{ item.label }}">{{ item.label }}:</div>
          <div class="col-sm-8 editable" data-field="{{ item.field }}">
            {% if item.field == 'full_name' and user.get_full_name %}
              {{ user.get_full_name }}
            {% elif item.field == 'phone' and user.phone %}
              {{ user.phone }}
            {% else %}
              <span class="text-muted fst-italic">Click to set {{ item.label|lower }}</span>
            {% endif %}
            <i class="bi bi-pencil-square ms-2 text-secondary"></i>
          </div>
        </div>
      {% endfor %}

      <!-- Static fields -->
      <div class="row mb-2"><div class="col-sm-4 fw-semibold text-muted">Username:</div><div class="col-sm-8">{{ user.username }}</div></div>
      <div class="row mb-2"><div class="col-sm-4 fw-semibold text-muted">Email:</div><div class="col-sm-8">{{ user.email }}</div></div>
      <div class="row mb-2"><div class="col-sm-4 fw-semibold text-muted">Status:</div><div class="col-sm-8 text-capitalize">{{ user.status }}</div></div>
      <div class="row mb-2"><div class="col-sm-4 fw-semibold text-muted">Joined On:</div><div class="col-sm-8">{{ user.date_joined|date:"F j, Y" }}</div></div>
    </div>
  </div>

  <!-- Profile Specific Card -->
  {% if user.student_profile %}
  <div class="card shadow-sm border-0 mb-4">
    <div class="card-header bg-white fw-bold">Student Profile</div>
    <div class="card-body px-4 py-3">
      {% for item in student_fields %}
        <div class="row mb-2">
          <div class="col-sm-4 fw-semibold text-muted">{{ item.label }}:</div>
          <div class="col-sm-8 editable" data-field="{{ item.field }}">
            {% if student_data|get_item:item.field %}
              {{ student_data|get_item:item.field }}
            {% else %}
              <span class="text-muted fst-italic">Click to set {{ item.label|lower }}</span>
            {% endif %}
          </div>
        </div>
      {% endfor %}
    </div>
  </div>

  {% elif user.instructor_profile %}
  <div class="card shadow-sm border-0 mb-4">
    <div class="card-header bg-white fw-bold">Instructor Profile</div>
    <div class="card-body px-4 py-3">
      {% for item in instructor_fields %}
        <div class="row mb-2">
          <div class="col-sm-4 fw-semibold text-muted">{{ item.label }}:</div>
          <div class="col-sm-8 editable" data-field="{{ item.field }}">
            {% with value=instructor_data|get_item:item.field %}
              {% if value %}
                {% if item.field == 'linkedin' %}
                  <a href="{{ value }}" target="_blank">{{ value }}</a>
                {% else %}
                  {{ value }}
                {% endif %}
              {% else %}
                <span class="text-muted fst-italic">Click to set {{ item.label|lower }}</span>
              {% endif %}
            {% endwith %}
          </div>
        </div>
      {% endfor %}
    </div>
  </div>

  {% elif user.provider_profile %}
  <div class="card shadow-sm border-0 mb-4">
    <div class="card-header bg-white fw-bold">Course Provider Profile</div>
    <div class="card-body px-4 py-3">
      {% for item in provider_fields %}
        <div class="row mb-2">
          <div class="col-sm-4 fw-semibold text-muted">{{ item.label }}:</div>
          <div class="col-sm-8 editable" data-field="{{ item.field }}">
            {% with value=provider_data|get_item:item.field %}
              {% if value %}
                {{ value }}
              {% else %}
                <span class="text-muted fst-italic">Click to set {{ item.label|lower }}</span>
              {% endif %}
            {% endwith %}
            <i class="bi bi-pencil-square ms-2 text-secondary"></i>
          </div>
        </div>
      {% endfor %}
    </div>
  </div>
  {% endif %}

  <div class="mt-4 text-center">
  {% if user.role == 'instructor' %}
    <a href="{% url 'lectures:instructor_dashboard' %}" class="btn btn-primary px-5 py-2">Back to Dashboard</a>
  {% elif user.role == 'student' %}
    <a href="{% url 'student_dashboard' %}" class="btn btn-primary px-5 py-2">Back to Dashboard</a>
  {% elif user.role == 'admin' %}
    <a href="{% url 'admin:index' %}" class="btn btn-primary px-5 py-2">Back to Admin Dashboard</a>
  {% elif user.role == 'course_provider' %}
    <a href="{% url 'course_provider:dashboard' %}" class="btn btn-primary px-5 py-2">Back to Dashboard</a>
  {% else %}
    <a href="/" class="btn btn-primary px-5 py-2">Back to Home</a>
  {% endif %}
</div>

</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

<script>
  // Tooltips
  var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
  var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
    return new bootstrap.Tooltip(tooltipTriggerEl);
  });

  // Inline editing
  document.querySelectorAll('.editable').forEach(el => {
    el.addEventListener('click', function handler() {
      const field = el.dataset.field;
      let current = el.textContent.trim();
      const input = document.createElement('input');
      input.type = 'text';
      input.value = (current.includes("Click to set") || current === "Not Set") ? "" : current;
      input.className = 'form-control d-inline w-auto';
      el.replaceWith(input);
      input.focus();

      input.addEventListener('blur', () => {
        let value = input.value.trim();

        if (field === 'phone' && value && !/^\+?\d{10,15}$/.test(value)) { alert("Enter valid phone"); input.focus(); return; }
        if (field === 'linkedin' && value && !/^https?:\/\/(www\.)?linkedin\.com\/.*$/.test(value)) { alert("Enter valid LinkedIn URL"); input.focus(); return; }

        fetch("{% url 'update_profile_field' %}", {
          method:'POST', headers:{'X-CSRFToken':'{{ csrf_token }}','Content-Type':'application/x-www-form-urlencoded'}, 
          body:`field=${field}&value=${encodeURIComponent(value)}`
        })
        .then(res=>res.json()).then(data=>{
          if(data.status==='success'){
            const newEl=document.createElement('div');
            newEl.className='editable'; newEl.dataset.field=field;
            if(field==='linkedin' && value){ newEl.innerHTML=`<a href="${value}" target="_blank">${value}</a><i class="bi bi-pencil-square ms-2 text-secondary"></i>`; }
            else { newEl.innerHTML=value||`<span class="text-muted fst-italic">Click to set ${field.replace("_"," ")}</span><i class="bi bi-pencil-square ms-2 text-secondary"></i>`; }
            input.replaceWith(newEl); newEl.addEventListener('click', handler);
          } else { alert(data.message); input.focus(); }
        }).catch(err=>console.error(err));
      });
    });
  });

  // رفع الصورة
  const photoInput = document.getElementById('photo-input');
  photoInput.addEventListener('change', function(){
    const file = this.files[0];
    if(!file) return;

    const formData = new FormData();
    formData.append('photo', file);

    fetch("{% url 'update_profile_photo' %}", {method:'POST', headers:{'X-CSRFToken':'{{ csrf_token }}'}, body:formData})
      .then(res=>res.json()).then(data=>{
        if(data.status==='success'){ document.getElementById('profile-photo').src=data.url; }
        else { alert(data.message); }
      }).catch(err=>console.error(err));
  });

</script>
{% endblock %}
