{% extends "dashboards/instructor_base.html" %}
{% load static %}
{% load widget_tweaks %}

{% block title %}Module Wizard | Instructor Dashboard{% endblock %}

{% block content %}
<style>
.zoom-field:required {
  border-left: 3px solid #dc3545 !important;
}
.zoom-field:valid {
  border-left: 3px solid #198754 !important;
}
</style>
<div class="container mt-4 mb-5">
  <h2 class="fw-bold mb-4">ğŸ§­ Add Module Wizard</h2>

  <!-- Wizard Tabs -->
  <ul class="nav nav-tabs" id="wizardTabs" role="tablist">
    <li class="nav-item">
      <button class="nav-link active" id="step1-tab" data-bs-toggle="tab" data-bs-target="#step1" type="button">1ï¸âƒ£
        Module Info</button>
    </li>
    <li class="nav-item">
      <button class="nav-link disabled" id="step2-tab" data-bs-toggle="tab" data-bs-target="#step2" type="button">2ï¸âƒ£
        Add Lectures</button>
    </li>
    <li class="nav-item">
      <button class="nav-link disabled" id="step3-tab" data-bs-toggle="tab" data-bs-target="#step3" type="button">3ï¸âƒ£
        Quiz / Case Studies</button>
    </li>
  </ul>

  <!-- Tab Content -->
  <div class="tab-content border border-top-0 p-4 rounded-bottom shadow-sm bg-white" id="wizardContent">

    <!-- STEP 1 -->
 <div class="tab-pane fade show active" id="step1" role="tabpanel">
  <form id="moduleForm" enctype="multipart/form-data">
    {% csrf_token %}

    <!-- Module Type -->
    <div class="mb-3">
      <label class="form-label fw-bold">Module Type</label>
      <select id="moduleType" class="form-select" name="module_type" required>
        <option value="">-- Select type --</option>
        <option value="basic">Basic</option>
        <option value="clinical">Clinical</option>
      </select>
    </div>

    <!-- System -->
    <div class="mb-3">
      <label class="form-label fw-bold">System</label>
      <select id="moduleSystem" class="form-select" disabled>
        <option value="">Select a type first...</option>
      </select>
    </div>

    <!-- Module fields -->
    <div id="module_rest">
      <div class="mb-3">
        <label for="{{ module_form.thumbnail.id_for_label }}" class="form-label fw-bold">Thumbnail</label>
        {{ module_form.thumbnail|add_class:"form-control" }}
      </div>

      <div class="mb-3">
        <label for="{{ module_form.description.id_for_label }}" class="form-label fw-bold">Description</label>
        {{ module_form.description|add_class:"form-control" }}
      </div>

      <div class="mb-3">
        <label for="{{ module_form.price.id_for_label }}" class="form-label fw-bold">Price</label>
        {{ module_form.price|add_class:"form-control" }}
      </div>
    </div>

    <!-- Submit -->
    <button type="submit" class="btn btn-primary mt-3 w-100">Next â†’ Add Lectures</button>

    <!-- Hidden fields -->
    <div id="hidden_systems" style="display:none;">
      {{ module_form.basic_system }}
      {{ module_form.clinical_system }}
      {{ module_form.instructor_share }}
      {{ module_form.platform_share }}
      {{ module_form.is_featured }}
      {{ module_form.status }}
    </div>
  </form>

  <div id="moduleMsg" class="mt-3"></div>
</div>

    <!-- STEP 2 -->
  <div class="tab-pane fade" id="step2" role="tabpanel">
   <form id="lectureForm" enctype="multipart/form-data">
  {% csrf_token %}
  {% load widget_tweaks %}

  {% for field in lecture_form %}
  <div class="mb-3">
      <label for="{{ field.id_for_label }}" class="form-label fw-bold">{{ field.label }}</label>
      {{ field|add_class:"form-control" }}
      {% if field.help_text %}
          <small class="text-muted">{{ field.help_text }}</small>
      {% endif %}
      {% for error in field.errors %}
          <div class="text-danger small">{{ error }}</div>
      {% endfor %}
  </div>
  {% endfor %}

  <!-- ğŸ”µ Ù‚Ø³Ù… Zoom Ø§Ù„Ø¢Ù…Ù† -->
<div id="zoomSection" class="border rounded p-4 mt-4 mb-3 bg-light" style="display: none;">
  <h5 class="fw-bold mb-3">ğŸ¥ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø¨Ø« Ø§Ù„Ù…Ø¨Ø§Ø´Ø± Ø§Ù„Ø¢Ù…Ù†</h5>
  
  <div class="row g-3">
    <div class="col-md-6">
      <label for="id_zoom_start_time" class="form-label fw-bold">ÙˆÙ‚Øª Ø§Ù„Ø¨Ø¯Ø¡ <span class="text-danger">*</span></label>
      <input type="datetime-local" id="id_zoom_start_time" name="zoom_start_time" 
             class="form-control zoom-field" required placeholder="YYYY-MM-DDTHH:MM">
      <small class="text-muted">Ø§Ø®ØªØ± ØªØ§Ø±ÙŠØ® ÙˆÙˆÙ‚Øª Ø§Ù„Ø¨Ø¯Ø¡ (ÙŠØ¬Ø¨ Ø£Ù† ÙŠÙƒÙˆÙ† ÙÙŠ Ø§Ù„Ù…Ø³ØªÙ‚Ø¨Ù„)</small>
    </div>
    
    <div class="col-md-6">
      <label for="id_zoom_duration" class="form-label fw-bold">Ø§Ù„Ù…Ø¯Ø© (Ø¯Ù‚Ø§Ø¦Ù‚) <span class="text-danger">*</span></label>
      <input type="number" id="id_zoom_duration" name="zoom_duration" 
             class="form-control zoom-field" value="60" min="15" max="480" step="15" required>
      <small class="text-muted">Ø§Ù„Ù…Ø¯Ø© Ø¨Ø§Ù„Ø¯Ù‚Ø§Ø¦Ù‚ (15-480)</small>
    </div>
  </div>

  <div class="mt-3 p-3 bg-info bg-opacity-10 rounded border">
    <h6 class="fw-bold text-info">ğŸ’¡ Ù…Ù„Ø§Ø­Ø¸Ø© Ù‡Ø§Ù…Ø©:</h6>
    <p class="small mb-0">Ø³ÙŠØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ø¬ØªÙ…Ø§Ø¹ Zoom ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ Ø¹Ù†Ø¯ Ø­ÙØ¸ Ø§Ù„Ù…Ø­Ø§Ø¶Ø±Ø©. ØªØ£ÙƒØ¯ Ù…Ù† ØµØ­Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù‚Ø¨Ù„ Ø§Ù„Ø­ÙØ¸.</p>
  </div>
</div>

<!-- Ø²Ø± Debug Ù„Ù„Ø§Ø®ØªØ¨Ø§Ø± -->
<div class="mt-3">
  <button type="button" id="debugZoom" class="btn btn-warning btn-sm">ğŸ› Debug Zoom Values</button>
</div>

  <button type="submit" class="btn btn-success mt-2 w-100">Save Lecture</button>
</form>

   
<script>
document.addEventListener("DOMContentLoaded", function () {
  // ğŸ”µ Ø¥ØµÙ„Ø§Ø­ Ù…Ø´ÙƒÙ„Ø© datetime-local
  const zoomStartTimeField = document.getElementById('id_zoom_start_time');
  
  if (zoomStartTimeField) {
    // ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ù‚ÙŠÙ…Ø© Ø¥Ù„Ù‰ Ø§Ù„ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„ØµØ­ÙŠØ­
    zoomStartTimeField.addEventListener('change', function() {
      if (this.value) {
        console.log('ğŸ•’ Zoom Start Time Selected:', this.value);
      }
    });

    // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ù‚ÙŠÙ…Ø© Ø¹Ù†Ø¯ Ø§Ù„ØªØ­Ù…ÙŠÙ„
    if (zoomStartTimeField.value) {
      console.log('ğŸ•’ Existing Zoom Start Time:', zoomStartTimeField.value);
    }
  }

  // ØªØ­Ø³ÙŠÙ† ØªØ¬Ø±Ø¨Ø© datetime-local (Ù…ØµØ­Ø­)
  function enhanceDateTimeLocal() {
    const zoomStartTime = document.getElementById('id_zoom_start_time');
    
    if (zoomStartTime) {
      // ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ø¯Ù†Ù‰ (Ø§Ù„Ø¢Ù† + 30 Ø¯Ù‚ÙŠÙ‚Ø©)
      const now = new Date();
      now.setMinutes(now.getMinutes() + 30);
      zoomStartTime.min = now.toISOString().slice(0, 16);
      
      // ğŸš« Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ù‚ÙŠÙ…Ø© Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠØ© Ø§Ù„Ø«Ø§Ø¨ØªØ© - Ø¯Ø¹ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙŠØ®ØªØ§Ø±
      // Ù„Ø§ ØªØ¶Ù Ù‚ÙŠÙ…Ø© Ø§ÙØªØ±Ø§Ø¶ÙŠØ© ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹
      
      // Ø¥Ø¶Ø§ÙØ© placeholder
      zoomStartTime.placeholder = "YYYY-MM-DDTHH:MM";
      
      // Ø¹Ø±Ø¶ Ø§Ù„ÙˆÙ‚Øª Ø§Ù„Ø­Ø§Ù„ÙŠ Ù„Ù„Ù…Ø³Ø§Ø¹Ø¯Ø©
      const timeHelper = document.createElement('div');
      timeHelper.className = 'text-info small mt-1';
      timeHelper.id = 'timeHelper';
      timeHelper.innerHTML = `â° Ø§Ù„ÙˆÙ‚Øª Ø§Ù„Ø­Ø§Ù„ÙŠ: <strong>${new Date().toLocaleString('ar-EG')}</strong>`;
      
      zoomStartTime.parentNode.appendChild(timeHelper);
      
      // ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙˆÙ‚Øª ÙƒÙ„ Ø¯Ù‚ÙŠÙ‚Ø©
      setInterval(() => {
        const currentTime = new Date();
        timeHelper.innerHTML = `â° Ø§Ù„ÙˆÙ‚Øª Ø§Ù„Ø­Ø§Ù„ÙŠ: <strong>${currentTime.toLocaleString('ar-EG')}</strong>`;
      }, 60000);
      
      // Ù…Ø±Ø§Ù‚Ø¨Ø© Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª
      zoomStartTime.addEventListener('input', function() {
        console.log('ğŸ“… DateTime changed:', this.value);
        
        // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø£Ù† Ø§Ù„ÙˆÙ‚Øª ÙÙŠ Ø§Ù„Ù…Ø³ØªÙ‚Ø¨Ù„
        if (this.value) {
          const selectedTime = new Date(this.value);
          const now = new Date();
          
          if (selectedTime <= now) {
            timeHelper.innerHTML = `âŒ <strong>ØªØ­Ø°ÙŠØ±:</strong> Ø§Ù„ÙˆÙ‚Øª Ø§Ù„Ù…Ø®ØªØ§Ø± ÙÙŠ Ø§Ù„Ù…Ø§Ø¶ÙŠ!`;
            timeHelper.className = 'text-danger small mt-1';
          } else {
            const diffMinutes = Math.round((selectedTime - now) / (1000 * 60));
            timeHelper.innerHTML = `âœ… Ø§Ù„ÙˆÙ‚Øª Ø§Ù„Ù…Ø®ØªØ§Ø± ØµØ­ÙŠØ­ (Ø¨Ø¹Ø¯ ${diffMinutes} Ø¯Ù‚ÙŠÙ‚Ø©)`;
            timeHelper.className = 'text-success small mt-1';
          }
        }
      });
    }
  }

  // âœ… Ø§Ø³ØªØ¯Ø¹Ø§Ø¡ Ø§Ù„Ø¯Ø§Ù„Ø© Ù…Ø±Ø© ÙˆØ§Ø­Ø¯Ø© ÙÙ‚Ø·
  enhanceDateTimeLocal();

  const typeField = document.querySelector("#id_lecture_type");
  const videoFileField = document.querySelector("#id_video_file")?.closest(".mb-3");
  const videoUrlField = document.querySelector("#id_video_url")?.closest(".mb-3");
  const zoomSection = document.getElementById("zoomSection");
  const zoomStartTime = document.getElementById('id_zoom_start_time');
  const zoomDuration = document.getElementById('id_zoom_duration');
  
  if (zoomStartTime && zoomDuration) {
    console.log('âœ… Zoom fields are properly initialized');
    
    // ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ø¯Ù†Ù‰ Ù„Ù„ØªØ§Ø±ÙŠØ®
    const now = new Date();
    now.setMinutes(now.getMinutes() + 30);
    zoomStartTime.min = now.toISOString().slice(0, 16);
    
    // ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ù‚ÙŠÙ… Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠØ© Ø¥Ø°Ø§ ÙƒØ§Ù†Øª ÙØ§Ø±ØºØ©
    if (!zoomDuration.value) {
      zoomDuration.value = 60;
    }
  } else {
    console.log('âŒ Zoom fields not found');
  }

  // âœ… Ø¯Ø§Ù„Ø© Ø§Ù„ØªØ­ÙƒÙ… ÙÙŠ Ø§Ù„Ø­Ù‚ÙˆÙ„ - Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ù…Ø­Ø³Ù†Ø©
  function updateLectureTypeFields() {
    if (!typeField) return;
    const value = typeField.value?.toLowerCase();
    
    console.log('ğŸ” Lecture Type Changed:', value);

    // Ø¥Ø®ÙØ§Ø¡ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø£ÙˆÙ„Ø§Ù‹
    if (videoFileField) videoFileField.style.display = "none";
    if (videoUrlField) videoUrlField.style.display = "none";
    if (zoomSection) zoomSection.style.display = "none";

    // ğŸŸ¢ Ø¥Ù„ØºØ§Ø¡ required Ù…Ù† Ø¬Ù…ÙŠØ¹ Ø­Ù‚ÙˆÙ„ Zoom
    const zoomFields = document.querySelectorAll('.zoom-field');
    zoomFields.forEach(field => {
      field.required = false;
    });

    // ğŸ¥ Ø­Ø§Ù„Ø© Ø§Ù„ÙÙŠØ¯ÙŠÙˆ Ø§Ù„Ù…Ø³Ø¬Ù„
    if (value.includes("video") || value.includes("recorded") || value.includes("upload")) {
      console.log('ğŸ¥ Showing video fields');
      if (videoFileField) videoFileField.style.display = "block";
      if (videoUrlField) videoUrlField.style.display = "block";
    }
    // ğŸ”µ Ø­Ø§Ù„Ø© Ø§Ù„Ø²ÙˆÙ… Ø§Ù„Ù…Ø¨Ø§Ø´Ø±
    else if (value.includes("zoom")) {
      console.log('ğŸ”µ Showing Zoom fields');
      if (zoomSection) {
        zoomSection.style.display = "block";
        
        // ğŸŸ¢ Ø¬Ø¹Ù„ Ø§Ù„Ø­Ù‚ÙˆÙ„ Ù…Ø·Ù„ÙˆØ¨Ø© ÙÙ‚Ø· Ø¹Ù†Ø¯Ù…Ø§ ØªÙƒÙˆÙ† Ø¸Ø§Ù‡Ø±Ø©
        const zoomStartTime = document.getElementById('id_zoom_start_time');
        const zoomDuration = document.getElementById('id_zoom_duration');
        
        if (zoomStartTime) zoomStartTime.required = true;
        if (zoomDuration) zoomDuration.required = true;
      }
    }
  }

  updateLectureTypeFields();

  // âœ… Ø¹Ù†Ø¯ ØªØºÙŠÙŠØ± Ù†ÙˆØ¹ Ø§Ù„Ù…Ø­Ø§Ø¶Ø±Ø©
  typeField?.addEventListener("change", updateLectureTypeFields);

  // Ø²Ø± Debug Ù…Ø­Ø³Ù† Ù„Ù„Ø§Ø®ØªØ¨Ø§Ø±
  document.getElementById('debugZoom')?.addEventListener('click', function() {
    const form = document.getElementById('lectureForm');
    const formData = new FormData(form);
    
    const lectureType = document.querySelector("#id_lecture_type").value;
    const zoomStartTimeInput = document.getElementById('id_zoom_start_time');
    const zoomDurationInput = document.getElementById('id_zoom_duration');
    
    const zoomStartTime = zoomStartTimeInput.value;
    const zoomDuration = zoomDurationInput.value;
    
    console.log('ğŸ› Detailed Debug Information:');
    console.log('ğŸ“ Lecture Type:', lectureType);
    console.log('ğŸ•’ Zoom Start Time:', zoomStartTime);
    console.log('â±ï¸ Zoom Duration:', zoomDuration);
    console.log('ğŸ” Input Properties:', {
      value: zoomStartTimeInput.value,
      type: zoomStartTimeInput.type,
      min: zoomStartTimeInput.min,
      max: zoomStartTimeInput.max
    });
    console.log('ğŸ“¦ FormData Zoom Values:', {
      startTime: formData.get('zoom_start_time'),
      duration: formData.get('zoom_duration')
    });
    
    // Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ù€ Date object
    if (zoomStartTime) {
      const testDate = new Date(zoomStartTime);
      console.log('ğŸ“… Date Object Test:', {
        isoString: testDate.toISOString(),
        localString: testDate.toLocaleString(),
        isValid: !isNaN(testDate.getTime())
      });
    }
    
    alert(`ğŸ› Debug Information:
ğŸ“ Lecture Type: ${lectureType}
ğŸ•’ Zoom Start Time: ${zoomStartTime || 'EMPTY'}
â±ï¸ Zoom Duration: ${zoomDuration}
âœ… Valid: ${zoomStartTime && zoomDuration ? 'YES' : 'NO'}`
    );
  });
});
</script>

    <div class="mt-4">
        <h5 class="fw-bold">ğŸ“š Lectures Added</h5>
        <ul id="lectureList" class="list-group small"></ul>
    </div>

    <button id="toStep3" class="btn btn-secondary mt-4 w-100" disabled>Next â†’ Quiz / Case Studies</button>
</div>

    <!-- STEP 3 -->
    <div class="tab-pane fade" id="step3" role="tabpanel">
      <h5 class="fw-bold mb-3">ğŸ§© Add Quiz / Case Study</h5>

      <ul class="nav nav-tabs mb-3" id="quizCaseTabs" role="tablist">
        <li class="nav-item" role="presentation">
          <button class="nav-link active" id="quiz-tab" data-bs-toggle="tab" data-bs-target="#quizTab" type="button" role="tab">Quiz</button>
        </li>
        <li class="nav-item" role="presentation">
          <button class="nav-link" id="case-tab" data-bs-toggle="tab" data-bs-target="#caseTab" type="button" role="tab">Case Study</button>
        </li>
      </ul>

      <div class="tab-content">
        <!-- QUIZ TAB -->
        <div class="tab-pane fade show active" id="quizTab" role="tabpanel">
          <div class="mb-3">
            <label for="lectureSelectQuiz" class="form-label">Select Lecture</label>
            <select id="lectureSelectQuiz" class="form-select"></select>
          </div>

          <form id="quizForm">
            {% csrf_token %}
            <div class="mb-3">
              <label class="form-label fw-bold">Quiz Title</label>
              <input type="text" name="title" class="form-control" required>
            </div>
            <button type="submit" class="btn btn-primary w-100">Create Quiz</button>
          </form>

          <div id="quizMsg" class="mt-3"></div>

          <!-- ADD QUESTIONS -->
          <div id="questionSection" class="mt-4" style="display:none;">
            <hr>
            <h5 class="fw-bold">â• Add Questions</h5>
            <form id="questionForm">
              {% csrf_token %}
              <div class="mb-2">
                <label class="form-label">Question Text</label>
                <input type="text" name="text" class="form-control" required>
              </div>

              <div id="choicesContainer" class="mb-2">
                <label class="form-label">Choices</label>
                <div class="input-group mb-1">
                  <input type="text" class="form-control" name="choices[]" placeholder="Choice 1">
                  <button type="button" class="btn btn-outline-success mark-correct">âœ“</button>
                </div>
              </div>

              <button type="button" id="addChoiceBtn" class="btn btn-sm btn-outline-secondary mb-3">Add Choice</button>
              <input type="hidden" name="correct_choice" id="correctChoiceInput">

              <div>
                <label class="form-label">Correct Answer (optional)</label>
                <input type="text" name="correct_answer" class="form-control">
              </div>

              <button type="submit" class="btn btn-success w-100 mt-3">Save Question</button>
            </form>

            <ul id="questionList" class="list-group mt-3 small"></ul>
          </div>
        </div>

        <!-- CASE STUDY TAB -->
        <div class="tab-pane fade" id="caseTab" role="tabpanel">
          <div class="mb-3">
            <label for="lectureSelectCase" class="form-label fw-bold">Select Lecture</label>
            <select id="lectureSelectCase" class="form-select"></select>
          </div>

          <form id="caseForm" enctype="multipart/form-data">
            {% csrf_token %}

            <div class="mb-3">
              <label class="form-label fw-bold">Case Study Title</label>
              <input type="text" name="title" class="form-control" placeholder="Enter case title..." required>
            </div>

            <div class="mb-3">
              <label class="form-label fw-bold">Symptoms</label>
              <textarea name="symptoms" class="form-control" rows="3" placeholder="Describe patient symptoms..." required></textarea>
            </div>

            <div class="mb-3">
              <label class="form-label fw-bold">Analysis / Discussion</label>
              <textarea name="analysis" class="form-control" rows="4" placeholder="Write your analysis or findings..." required></textarea>
            </div>

            <div class="mb-3">
              <label class="form-label fw-bold">Description (Optional)</label>
              <textarea name="description" class="form-control" rows="3" placeholder="Additional notes..."></textarea>
            </div>

            <div class="row">
              <div class="col-md-6 mb-3">
                <label class="form-label fw-bold">Upload Video (optional)</label>
                <input type="file" name="video_file" class="form-control" accept="video/*">
              </div>
              <div class="col-md-6 mb-3">
                <label class="form-label fw-bold">or Video URL (YouTube, Vimeo...)</label>
                <input type="url" name="video_url" class="form-control" placeholder="https://...">
              </div>
            </div>

            <div class="mb-3">
              <label class="form-label fw-bold">Attach File (optional)</label>
              <input type="file" name="attachment" class="form-control" accept=".pdf,.jpg,.jpeg,.png,.doc,.docx">
            </div>

            <button type="submit" class="btn btn-primary w-100">ğŸ’¾ Save Case Study</button>
          </form>

          <div id="caseMsg" class="mt-3"></div>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function () {
  const moduleType = document.getElementById('moduleType');
  const moduleSystem = document.getElementById('moduleSystem');
  const hiddenContainer = document.getElementById('hidden_systems');
  const moduleForm = document.getElementById('moduleForm');
  const moduleMsg = document.getElementById('moduleMsg');
  const step2Tab = document.getElementById('step2-tab');
  const lectureForm = document.getElementById('lectureForm');
  const lectureList = document.getElementById('lectureList');
  const toStep3Btn = document.getElementById('toStep3');

  const basicSelectHidden = hiddenContainer.querySelector('select[name="basic_system"]');
  const clinicalSelectHidden = hiddenContainer.querySelector('select[name="clinical_system"]');
  const disciplineSelect = lectureForm.querySelector('#id_discipline');

  function alertBox(type, message) {
    return `<div class="alert alert-${type} alert-dismissible fade show" role="alert">
    ${message}<button type="button" class="btn-close" data-bs-dismiss="alert"></button></div>`;
  }

  function parseErrors(errors) {
    if (typeof errors === 'string') return errors;
    return Object.entries(errors).map(([k, v]) => `<strong>${k}</strong>: ${v}`).join('<br>');
  }

  function populateSystemSelect(hiddenSelect) {
    if (!hiddenSelect) return;
    moduleSystem.innerHTML = '<option value="">-- Select System --</option>';
    Array.from(hiddenSelect.options).forEach(opt => {
      if (opt.value) {
        const newOpt = document.createElement('option');
        newOpt.value = opt.value;
        newOpt.textContent = opt.textContent;
        moduleSystem.appendChild(newOpt);
      }
    });
    moduleSystem.disabled = false;
  }

  function populateDisciplines(systemId) {
    if (!disciplineSelect || !systemId) return;
    fetch(`/lectures/ajax/load-disciplines/?system_id=${systemId}`)
      .then(res => res.json())
      .then(data => {
        disciplineSelect.innerHTML = '<option value="">-- Select Discipline --</option>';
        data.forEach(d => {
          const opt = document.createElement('option');
          opt.value = d.id;
          opt.textContent = d.name;
          disciplineSelect.appendChild(opt);
        });
      });
  }

  moduleType.addEventListener('change', function () {
    moduleSystem.innerHTML = '<option value="">Select a type first...</option>';
    moduleSystem.disabled = true;
    if (this.value === 'basic') populateSystemSelect(basicSelectHidden);
    else if (this.value === 'clinical') populateSystemSelect(clinicalSelectHidden);
  });

  moduleSystem.addEventListener('change', function () {
    if (moduleType.value === 'basic') populateDisciplines(this.value);
    else if (disciplineSelect) {
        disciplineSelect.innerHTML = '<option value="none">-- Clinical does not use disciplines --</option>';
    }
  });

  // âœ… Ø¯Ø§Ù„Ø© ONE ÙÙ‚Ø· Ù„Ø­ÙØ¸ Ø§Ù„Ù…ÙˆØ¯ÙŠÙˆÙ„ - Ø¨Ø¯ÙˆÙ† ØªÙƒØ±Ø§Ø±
  moduleForm.addEventListener('submit', async function (e) {
    e.preventDefault();
    const type = moduleType.value;
    const systemId = moduleSystem.value;
    if (!type || !systemId) {
      moduleMsg.innerHTML = alertBox('danger', 'Please select both module type and system.');
      return;
    }

    const fd = new FormData(moduleForm);

    // âœ… Ø§Ù„ØªØµØ­ÙŠØ­: Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ø§Ù„Ø­Ù‚Ù„ Ø£ÙˆÙ„Ø§Ù‹
    if (fd.has('discipline')) {
      const disciplineField = fd.get('discipline');
      if (disciplineField === 'none') {
        fd.set('discipline', '');
      }
    }

    fd.delete('basic_system');
    fd.delete('clinical_system');
    if (type === 'basic') fd.append('basic_system', systemId);
    else fd.append('clinical_system', systemId);

    const res = await fetch("{% url 'add_module' %}", { method: 'POST', body: fd });
    const data = await res.json();
    if (data.success) {
      moduleMsg.innerHTML = alertBox('success', 'âœ… Module saved successfully!');
      step2Tab.classList.remove('disabled');
      new bootstrap.Tab(step2Tab).show();
      window.moduleId = data.module_id;

      const moduleField = lectureForm.querySelector('[name="module"]');
      if (moduleField) {
        if (moduleField.tagName.toLowerCase() === 'select') {
          moduleField.innerHTML = '';
          const opt = document.createElement('option');
          opt.value = data.module_id;
          opt.textContent = data.module_name || 'New Module';
          moduleField.appendChild(opt);
          moduleField.value = data.module_id;
        } else {
          moduleField.value = data.module_id;
        }
      } else {
        const hidden = document.createElement('input');
        hidden.type = 'hidden';
        hidden.name = 'module';
        hidden.value = data.module_id;
        lectureForm.appendChild(hidden);
      }
    } else {
      moduleMsg.innerHTML = alertBox('danger', parseErrors(data.errors || 'Unknown error'));
    }
  });

  // âœ… Ø¯Ø§Ù„Ø© ONE ÙÙ‚Ø· Ù„Ø­ÙØ¸ Ø§Ù„Ù…Ø­Ø§Ø¶Ø±Ø© - Ù…Ø¹ Zoom Ø§Ù„Ù…ØµØ­Ø­ ØªÙ…Ø§Ù…Ø§Ù‹
  lectureForm.addEventListener('submit', async function (e) {
    e.preventDefault();
    
    // âœ… Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ moduleId
    if (!window.moduleId) {
      alert('âŒ ÙŠØ±Ø¬Ù‰ Ø­ÙØ¸ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù…ÙˆØ¯ÙŠÙˆÙ„ Ø£ÙˆÙ„Ø§Ù‹ Ù‚Ø¨Ù„ Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø­Ø§Ø¶Ø±Ø§Øª');
      return;
    }
    
    const fd = new FormData(lectureForm);
    
    // âœ… ØªØ­Ù‚Ù‚ ÙŠØ¯ÙˆÙŠ Ù…Ù† Ø¨ÙŠØ§Ù†Ø§Øª Zoom
    const lectureType = document.querySelector("#id_lecture_type").value;
    const isZoomLecture = lectureType && lectureType.toLowerCase().includes('zoom');
    
    console.log('ğŸ” Lecture Type:', lectureType, 'isZoom:', isZoomLecture);
    
    if (isZoomLecture) {
      const zoomStartTimeInput = document.getElementById('id_zoom_start_time');
      const zoomDurationInput = document.getElementById('id_zoom_duration');
      
      const zoomStartTime = zoomStartTimeInput.value;
      const zoomDuration = zoomDurationInput.value;
      
      console.log('ğŸ” Zoom Values (Direct from inputs):', {
        startTime: zoomStartTime,
        duration: zoomDuration,
        startTimeInputValue: zoomStartTimeInput.value,
        durationInputValue: zoomDurationInput.value
      });
      
      // âœ… Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©
      if (!zoomStartTime || !zoomDuration) {
        alert('âŒ ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ ÙˆÙ‚Øª Ø§Ù„Ø¨Ø¯Ø¡ ÙˆØ§Ù„Ù…Ø¯Ø© Ù„Ù…Ø­Ø§Ø¶Ø±Ø© Zoom');
        
        // Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©
        if (!zoomStartTime) {
          zoomStartTimeInput.style.borderColor = 'red';
          zoomStartTimeInput.focus();
        }
        if (!zoomDuration) {
          zoomDurationInput.style.borderColor = 'red';
        }
        
        return;
      }
      
      // ğŸŒ ØªØ­Ù‚Ù‚ Ø´Ø§Ù…Ù„ Ù…Ù† Ø§Ù„ØªÙˆÙ‚ÙŠØª Ø§Ù„Ø²Ù…Ù†ÙŠ
      const startTime = new Date(zoomStartTime);
      const now = new Date();
      
      console.log('ğŸŒ TIMEZONE DEBUG:', {
        rawInputValue: zoomStartTime,
        selectedDate: startTime,
        currentDate: now,
        selectedLocal: startTime.toLocaleString('ar-EG'),
        currentLocal: now.toLocaleString('ar-EG'),
        selectedUTC: startTime.toISOString(),
        currentUTC: now.toISOString(),
        timeDifference: startTime.getTime() - now.getTime(),
        minutesDifference: (startTime.getTime() - now.getTime()) / (1000 * 60),
        browserTimezone: Intl.DateTimeFormat().resolvedOptions().timeZone
      });
      
      // âœ… Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø£Ù† Ø§Ù„ÙˆÙ‚Øª ÙÙŠ Ø§Ù„Ù…Ø³ØªÙ‚Ø¨Ù„ (Ù…Ø¹ buffer ØµØºÙŠØ±)
      const bufferTime = 2 * 60 * 1000; // 2 Ø¯Ù‚Ø§Ø¦Ù‚ buffer
      
      if (startTime.getTime() <= (now.getTime() + bufferTime)) {
        const diffMinutes = Math.round((now.getTime() - startTime.getTime()) / (1000 * 60));
        
        if (diffMinutes > 0) {
          alert(`âŒ ÙˆÙ‚Øª Ø§Ù„Ø¨Ø¯Ø¡ ÙÙŠ Ø§Ù„Ù…Ø§Ø¶ÙŠ! Ø§Ù„ÙØ±Ù‚: ${Math.abs(diffMinutes)} Ø¯Ù‚ÙŠÙ‚Ø©\n\n` +
                `Ø§Ù„ÙˆÙ‚Øª Ø§Ù„Ù…Ø®ØªØ§Ø±: ${startTime.toLocaleString('ar-EG')}\n` +
                `Ø§Ù„ÙˆÙ‚Øª Ø§Ù„Ø­Ø§Ù„ÙŠ: ${now.toLocaleString('ar-EG')}\n\n` +
                `ğŸ’¡ Ø§Ø®ØªØ± ÙˆÙ‚ØªØ§Ù‹ ÙÙŠ Ø§Ù„Ù…Ø³ØªÙ‚Ø¨Ù„ (Ø¨Ø¹Ø¯ ${now.toLocaleString('ar-EG')})`);
        } else {
          alert(`âš ï¸ ÙˆÙ‚Øª Ø§Ù„Ø¨Ø¯Ø¡ Ù‚Ø±ÙŠØ¨ Ø¬Ø¯Ø§Ù‹ Ù…Ù† Ø§Ù„Ø¢Ù†!\n\n` +
                `Ø§Ù„ÙˆÙ‚Øª Ø§Ù„Ù…Ø®ØªØ§Ø±: ${startTime.toLocaleString('ar-EG')}\n` +
                `Ø§Ù„ÙˆÙ‚Øª Ø§Ù„Ø­Ø§Ù„ÙŠ: ${now.toLocaleString('ar-EG')}\n\n` +
                `Ù‡Ù„ ØªØ±ÙŠØ¯ Ø§Ù„Ù…ØªØ§Ø¨Ø¹Ø©ØŸ`);
        }
        
        zoomStartTimeInput.style.borderColor = 'red';
        zoomStartTimeInput.focus();
        return;
      }
      
      // âœ… Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ù„ÙˆÙ†
      zoomStartTimeInput.style.borderColor = '';
      zoomDurationInput.style.borderColor = '';
      
      // ğŸ”µ Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù‚ÙŠÙ… ÙŠØ¯ÙˆÙŠØ§Ù‹ Ø¥Ù„Ù‰ FormData
      console.log('ğŸŸ¢ Adding Zoom data to FormData manually');
      fd.set('zoom_start_time', zoomStartTime);
      fd.set('zoom_duration', zoomDuration);
      
      // âœ… Ø§Ù„ØªØ­Ù‚Ù‚ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ Ù…Ù† FormData
      console.log('âœ… Final FormData Zoom values:', {
        startTime: fd.get('zoom_start_time'),
        duration: fd.get('zoom_duration')
      });
    }
    
    // ğŸŸ¢ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¥Ù„Ù‰ Ø§Ù„Ø®Ø§Ø¯Ù…
    try {
      console.log('ğŸš€ Sending request to server...');
      
      const res = await fetch(`/lectures/instructor/module/${window.moduleId}/lecture/add/`, {
        method: 'POST',
        body: fd,
        headers: {
          'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
        }
      });
      
      const data = await res.json();
      console.log('ğŸ“¨ Server response:', data);
      
      if (data.success) {
        // Ù†Ø¬Ø§Ø­ - Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø­Ø§Ø¶Ø±Ø© Ù„Ù„Ù‚Ø§Ø¦Ù…Ø©
        addLectureToList(data.lecture_title, data.lecture_id);
        lectureForm.reset();
        
        // ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø®Ø·ÙˆØ© Ø§Ù„ØªØ§Ù„ÙŠØ©
        toStep3Btn.disabled = false;
        
        // Ø¥Ø¸Ù‡Ø§Ø± Ø±Ø³Ø§Ù„Ø© Ù†Ø¬Ø§Ø­
        const msgDiv = document.createElement('div');
        msgDiv.innerHTML = alertBox('success', 'âœ… Lecture saved successfully!');
        lectureForm.parentNode.insertBefore(msgDiv, lectureForm.nextSibling);
        
        // Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ø¨Ø¹Ø¯ 3 Ø«ÙˆØ§Ù†ÙŠ
        setTimeout(() => {
          msgDiv.remove();
        }, 3000);
        
      } else {
        alert('âŒ Error: ' + parseErrors(data.errors));
      }
    } catch (error) {
      console.error('Error saving lecture:', error);
      alert('âŒ Network error occurred');
    }
  });

  function addLectureToList(title, id) {
    const item = document.createElement('li');
    item.className = 'list-group-item d-flex justify-content-between align-items-center';
    item.innerHTML = `${title} <span class="badge bg-secondary">${id}</span>`;
    lectureList.appendChild(item);

    const selectQuiz = document.getElementById('lectureSelectQuiz');
    const selectCase = document.getElementById('lectureSelectCase');
    [selectQuiz, selectCase].forEach(sel => {
      const opt = document.createElement('option');
      opt.value = id;
      opt.text = title;
      sel.add(opt);
    });
  }

  toStep3Btn.addEventListener('click', () => {
    document.getElementById('step3-tab').classList.remove('disabled');
    new bootstrap.Tab(document.getElementById('step3-tab')).show();
  });

  // ==== QUIZ CREATION ====
  let currentQuizId = null;

  document.getElementById('quizForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    const lectureId = document.getElementById('lectureSelectQuiz').value;
    const fd = new FormData(e.target);

    const res = await fetch(`/lectures/instructor/lecture/${lectureId}/quiz/add/`, { method: 'POST', body: fd });
    const data = await res.json();
    const quizMsg = document.getElementById('quizMsg');

    if (data.success) {
      currentQuizId = data.quiz_id;
      quizMsg.innerHTML = alertBox('success', 'Quiz created successfully!');
      document.getElementById('questionSection').style.display = 'block';
    } else {
      quizMsg.innerHTML = alertBox('danger', parseErrors(data.errors));
    }
  });

  const questionForm = document.getElementById('questionForm');
  const choicesContainer = document.getElementById('choicesContainer');
  const addChoiceBtn = document.getElementById('addChoiceBtn');
  const correctChoiceInput = document.getElementById('correctChoiceInput');
  const questionList = document.getElementById('questionList');

  addChoiceBtn.addEventListener('click', () => {
    const index = choicesContainer.querySelectorAll('.input-group').length + 1;
    const div = document.createElement('div');
    div.className = 'input-group mb-1';
    div.innerHTML = `
      <input type="text" class="form-control" name="choices[]" placeholder="Choice ${index}">
      <button type="button" class="btn btn-outline-success mark-correct">âœ“</button>
    `;
    choicesContainer.appendChild(div);
  });

  choicesContainer.addEventListener('click', (e) => {
    if (e.target.classList.contains('mark-correct')) {
      choicesContainer.querySelectorAll('.mark-correct').forEach(btn => btn.classList.remove('btn-success'));
      e.target.classList.add('btn-success');
      const index = Array.from(choicesContainer.querySelectorAll('.input-group')).indexOf(e.target.closest('.input-group'));
      correctChoiceInput.value = index;
    }
  });

  questionForm.addEventListener('submit', async (e) => {
    e.preventDefault();
    if (!currentQuizId) {
      alert('Please create a quiz first!');
      return;
    }

    const fd = new FormData(questionForm);

    const res = await fetch(`/lectures/instructor/quiz/${currentQuizId}/question/add/`, {
      method: 'POST',
      body: fd
    });

    const data = await res.json();

    if (data.success) {
      const li = document.createElement('li');
      li.className = 'list-group-item';
      li.textContent = fd.get('text');
      questionList.appendChild(li);
      questionForm.reset();
      correctChoiceInput.value = '';
      choicesContainer.innerHTML = `
        <label class="form-label">Choices</label>
        <div class="input-group mb-1">
          <input type="text" class="form-control" name="choices[]" placeholder="Choice 1">
          <button type="button" class="btn btn-outline-success mark-correct">âœ“</button>
        </div>`;
    } else {
      alert('Error: ' + parseErrors(data.errors));
    }
  });

  // ==== CASE STUDY CREATION ====
  document.getElementById('caseForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    const lectureId = document.getElementById('lectureSelectCase').value;
    const fd = new FormData(e.target);

    const res = await fetch(`/lectures/instructor/lecture/${lectureId}/case/add/`, { method: 'POST', body: fd });
    const data = await res.json();
    const caseMsg = document.getElementById('caseMsg');

    if (data.success) {
      caseMsg.innerHTML = alertBox('success', 'Case Study saved successfully!');
      e.target.reset();
    } else {
      caseMsg.innerHTML = alertBox('danger', parseErrors(data.errors));
    }
  });
});
</script>
{% endblock %}