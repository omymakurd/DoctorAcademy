{% extends "dashboards/instructor_base.html" %}
{% load static %}
{% block title %}Manage Module{% endblock %}

{% block content %}
<div class="container">

  <div class="d-flex justify-content-between align-items-center mb-4">
    <h2>{{ module.title }}</h2>
    <a href="{% url 'lectures:my_lectures' %}" class="btn btn-outline-secondary">Back</a>
  </div>

  <!-- Module info -->
  <div class="card mb-4">
    <div class="card-header fw-bold">Module Information</div>
    <div class="card-body">
      <div class="row">
        <div class="col-md-8">
          <p><strong>Description:</strong> {{ module.description }}</p>
          <p><strong>Price:</strong> {{ module.price }} EGP</p>
          <p><strong>Status:</strong> {{ module.get_status_display }}</p>

          <p><strong>Basic System:</strong>
            {% if module.basic_system %}{{ module.basic_system.name }}{% else %}None{% endif %}
          </p>

          <p><strong>Clinical System:</strong>
            {% if module.clinical_system %}{{ module.clinical_system.name }}{% else %}None{% endif %}
          </p>

          <p><strong>Total Duration:</strong> {{ module.total_duration_minutes }} minutes</p>

          <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#editModuleModal">
            Edit Module Info
          </button>
        </div>

        <div class="col-md-4 d-flex align-items-center justify-content-center">
          {# استخدام صورة افتراضية من الملفات المرفوعة إذا لم يوجد thumbnail #}
          <img src="{{ module.thumbnail.url|default:'/mnt/data/b1593973-6fa6-4167-9784-7cf593f8296f.png' }}"
               alt="{{ module.title }}" class="img-fluid rounded" style="max-height:200px;">
        </div>
      </div>
    </div>
  </div>

  {# ---------------- Edit Module Modal ---------------- #}
  <div class="modal fade" id="editModuleModal" tabindex="-1" aria-labelledby="editModuleModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
      <div class="modal-content">
        <form method="POST" action="{% url 'lectures:edit_module' module.id %}" enctype="multipart/form-data" id="editModuleForm">
          {% csrf_token %}
          <div class="modal-header">
            <h5 class="modal-title" id="editModuleModalLabel">Edit Module</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <div class="row g-3">
              <div class="col-md-8">
                <div class="mb-3">
                  <label for="module_title" class="form-label">Title</label>
                  <input type="text" class="form-control" id="module_title" name="title" value="{{ module.title }}" required>
                </div>

                <div class="mb-3">
                  <label for="module_description" class="form-label">Description</label>
                  <textarea class="form-control" id="module_description" name="description" rows="3">{{ module.description }}</textarea>
                </div>

                <div class="mb-3">
                  <label for="module_price" class="form-label">Price (EGP)</label>
                  <input type="number" class="form-control" id="module_price" name="price" value="{{ module.price }}" step="0.01" required>
                </div>

                <div class="mb-3">
                  <label class="form-label">Status</label>
                  <input type="text" class="form-control" value="{{ module.get_status_display }}" readonly>
                  <small class="text-muted">Status can only be changed by admin.</small>
                </div>

                <div class="mb-3">
                  <label for="module_total_duration_minutes" class="form-label">Total Duration (minutes)</label>
                  <input type="number" class="form-control" id="module_total_duration_minutes" name="total_duration_minutes" value="{{ module.total_duration_minutes }}">
                </div>

                <div class="mb-3">
                  <label for="basic_system" class="form-label">Basic System</label>
                  <select class="form-select" id="basic_system" name="basic_system">
                    <option value="">-- None --</option>
                    {% for system in basic_systems %}
                      <option value="{{ system.id }}" {% if module.basic_system and module.basic_system.id == system.id %}selected{% endif %}>{{ system.name }}</option>
                    {% endfor %}
                  </select>
                </div>

                <div class="mb-3">
                  <label for="clinical_system" class="form-label">Clinical System</label>
                  <select class="form-select" id="clinical_system" name="clinical_system">
                    <option value="">-- None --</option>
                    {% for system in clinical_systems %}
                      <option value="{{ system.id }}" {% if module.clinical_system and module.clinical_system.id == system.id %}selected{% endif %}>{{ system.name }}</option>
                    {% endfor %}
                  </select>
                </div>

                <div class="mb-3">
                  <label for="thumbnail" class="form-label">Thumbnail</label>
                  <input type="file" class="form-control" id="module_thumbnail" name="thumbnail">
                  {% if module.thumbnail %}
                    <small class="text-muted">Current: {{ module.thumbnail.name }}</small>
                  {% endif %}
                </div>
              </div>

              <div class="col-md-4 d-flex align-items-center justify-content-center">
                {% if module.thumbnail %}
                  <img src="{{ module.thumbnail.url }}" alt="{{ module.title }}" class="img-fluid rounded" style="max-height:200px;">
                {% else %}
                  <div class="text-center text-muted"><small>No thumbnail</small></div>
                {% endif %}
              </div>
            </div>
          </div>

          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
            <button type="submit" class="btn btn-primary">Save Changes</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  {# ---------------- Add Lecture Modal ---------------- #}
  <div class="modal fade" id="addLectureModal" tabindex="-1">
    <div class="modal-dialog modal-lg modal-dialog-centered">
      <div class="modal-content">
        <form method="POST" action="{% url 'lectures:add_lecture_modal' module.id %}" enctype="multipart/form-data" id="addLectureForm">
          {% csrf_token %}
          <div class="modal-header">
            <h5 class="modal-title">Add New Lecture</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
          </div>

          <div class="modal-body">
            <div class="row g-3">
              <div class="col-md-6">
                <label class="form-label">Lecture Title</label>
                <input type="text" id="addLectureTitle" name="title" class="form-control" required>
              </div>

              <div class="col-md-6">
                <label class="form-label">Lecture Type</label>
                <select name="lecture_type" id="addLectureType" class="form-select">
                  <option value="recorded">Recorded</option>
                  <option value="zoom">Live Zoom</option>
                </select>
              </div>

              <div class="col-md-12">
                <label class="form-label">Description</label>
                <textarea name="description" id="addLectureDescription" class="form-control"></textarea>
              </div>

              {% if module.basic_system %}
                <div class="col-md-12">
                  <label class="form-label">Discipline</label>
                  <select name="discipline" id="addLectureDiscipline" class="form-select" required>
                    <option value="">-- Select Discipline --</option>
                    {% for disc in module.basic_system.disciplines.all %}
                      <option value="{{ disc.id }}">{{ disc.get_name_display }}</option>
                    {% endfor %}
                  </select>
                </div>
              {% endif %}

              <div class="col-md-6">
                <label class="form-label">Order</label>
                <input type="number" name="order" id="addLectureOrder" class="form-control" value="1">
              </div>

              <div class="col-md-6">
                <label class="form-label">Video File</label>
                <input type="file" name="video_file" id="addLectureVideoFile" class="form-control">
              </div>
            </div>
          </div>

          <div class="modal-footer">
            <button class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
            <button class="btn btn-primary" type="submit">Add Lecture</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  {# ---------------- Lectures list ---------------- #}
  <div class="mb-4">
    <h4>Lectures</h4>
    <div class="mb-3">
      <button class="btn btn-success" data-bs-toggle="modal" data-bs-target="#addLectureModal">+ Add Lecture</button>
    </div>

    <ul id="lecturesList" class="list-group">
      {# نعرض الأسطر بدون سطور داخلية داخل data-* لتفادي مشاكل #}
      {% for lec in basic_lectures %}
  <li class="list-group-item sortable-item"
      data-id="{{ lec.id }}"
      data-title="{{ lec.title|escapejs }}"
      data-type="basic"
      data-video-url="{% if lec.video_file %}{{ lec.video_file.url }}{% elif lec.video_url %}{{ lec.video_url }}{% else %}#{% endif %}"
      data-discipline="{{ lec.discipline.get_name_display|escapejs }}"
      data-description="{{ lec.description|default:''|escapejs }}"
      data-quizzes='[{% for q in lec.quizzes.all %}{"id":{{ q.id }},"title":"{{ q.title|escapejs }}"}{% if not forloop.last %},{% endif %}{% endfor %}]'
      data-cases='[{% for c in lec.case_studies.all %}{"id":{{ c.id }},"title":"{{ c.title|escapejs }}"}{% if not forloop.last %},{% endif %}{% endfor %}]'
  >
    <div class="d-flex justify-content-between">
      <div><strong>{{ lec.title }}</strong> <span class="badge bg-secondary">Basic</span></div>
      <div class="text-muted small">{{ lec.order }}</div>
    </div>
  </li>
{% endfor %}


      {% for lec in clinical_lectures %}
        <li class="list-group-item sortable-item"
            data-id="{{ lec.id }}"
            data-type="clinical"
            data-title="{{ lec.title|escapejs }}"
            data-video-url="{% if lec.video_file %}{{ lec.video_file.url }}{% elif lec.video_url %}{{ lec.video_url }}{% else %}#{% endif %}"
            data-description="{{ lec.description|default:''|escapejs }}"
            data-quizzes='[{% for q in lec.quizzes.all %}{"id":{{ q.id }},"title":"{{ q.title|escapejs }}"}{% if not forloop.last %},{% endif %}{% endfor %}]'
           data-cases='[{% for c in lec.case_studies.all %}{"id":{{ c.id }},"title":"{{ c.title|escapejs }}"}{% if not forloop.last %},{% endif %}{% endfor %}]'

        >
          <div class="d-flex justify-content-between">
            <div><strong>{{ lec.title }}</strong> <span class="badge bg-secondary">Clinical</span></div>
            <div class="text-muted small">{{ lec.order }}</div>
          </div>
        </li>
      {% endfor %}
    </ul>
  </div>
  {# ---------------- Lecture Details Modal (full) ---------------- #}
  <div class="modal fade" id="lectureDetailModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-xl modal-dialog-centered">
      <div class="modal-content">

        <div class="modal-header">
          <h5 class="modal-title fw-bold" id="lectureDetailTitle"></h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>

        <div class="modal-body">
          <video id="lectureDetailVideo" class="w-100 rounded shadow-sm mb-3" controls>
            <source id="lectureVideoSource" src="" type="video/mp4">
            متصفحك لا يدعم تشغيل الفيديو.
          </video>

          <h6 class="fw-bold">Description</h6>
          <p id="lectureDetailDescription" class="text-muted"></p>

          <hr>

          <div class="row mb-3">
            <div class="col-md-4">
              <span class="fw-bold">Lecture Type:</span> <span id="lectureDetailType"></span>
            </div>

            <div class="col-md-4" id="lectureDisciplineBlock" style="display:none;">
              <span class="fw-bold">Discipline:</span> <span id="lectureDetailDiscipline"></span>
            </div>

            <div class="col-md-4" id="lectureZoomBlock" style="display:none;">
              <span class="fw-bold">Zoom:</span> <span id="lectureDetailZoom"></span>
            </div>
          </div>

          <div id="lectureResourcesBlock" style="display:none;">
            <h6 class="fw-bold">Resources</h6>
            <a id="lectureResourceLink" href="#" target="_blank" class="btn btn-outline-primary btn-sm">Download Resource</a>
          </div>

          <hr>
          <h6 class="fw-bold">Quizzes</h6>
<ul id="lectureQuizzesList" class="list-group mb-3">
  {# Initially filled by JS from data-quizzes attr on clicked li. #}
</ul>

<!-- Create Quiz Area -->
<div id="createQuizArea" class="mt-3">
    <input type="text" id="quiz_create_title" class="form-control mb-2" placeholder="Quiz Title">
    <button class="btn btn-primary" id="quizCreateBtn">Create Quiz</button>
</div>

<!-- Questions Section -->
<div id="quizQuestionsArea" style="display:none; margin-top:20px;">
    <h5>Questions for: <span id="currentQuizTitle"></span></h5>
    <ul id="questionsList" class="list-group mb-3"></ul>
    <button class="btn btn-success" id="openCreateQuestionBtn">+ Add Question</button>
</div>

<!-- Add Question Area (Create) -->
<div id="createQuestionArea" style="display:none; margin-top:20px;">
    <h5>Add Question</h5>

    <input type="text" id="createQuestionText" class="form-control mb-2" placeholder="Question text">

    <div id="mcqOptions_create">
        <input type="text" id="create_option1" class="form-control mb-1" placeholder="Option A">
        <input type="text" id="create_option2" class="form-control mb-1" placeholder="Option B">
        <input type="text" id="create_option3" class="form-control mb-1" placeholder="Option C">
        <input type="text" id="create_option4" class="form-control mb-1" placeholder="Option D">

        <select id="create_correctAnswer" class="form-select mt-2">
            <option value="1">Correct Answer: A</option>
            <option value="2">Correct Answer: B</option>
            <option value="3">Correct Answer: C</option>
            <option value="4">Correct Answer: D</option>
        </select>
    </div>

    <button class="btn btn-primary mt-2" id="saveCreateQuestionBtn">Save Question</button>
    <button class="btn btn-secondary mt-2" id="cancelCreateQuestionBtn">Cancel</button>
</div>

          <h6 class="fw-bold">Case Studies</h6>
          <ul id="lectureCasesList" class="list-group">
    <li class="list-group-item caseStudyItem" data-case-id="3">Case Title</li>
</ul>

            <!-- Add Case Study Modal -->
<!-- Add / Edit Case Study Modal -->
<div class="modal fade" id="addCaseModal" tabindex="-1">
  <div class="modal-dialog modal-lg modal-dialog-centered">
    <div class="modal-content">

      <form id="addCaseForm" enctype="multipart/form-data">
        <div class="modal-header">
          <h5 class="modal-title">Case Study</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>

        <div class="modal-body">

          <input type="hidden" id="caseLectureId" name="lecture_id">
          <input type="hidden" id="caseLectureType" name="lecture_type">

          <div class="mb-3">
            <label class="form-label">Title</label>
            <input type="text" id="caseTitle" name="title" class="form-control" required>
          </div>

          <div class="mb-3">
            <label class="form-label">Symptoms</label>
            <textarea id="caseSymptoms" name="symptoms" class="form-control" rows="3"></textarea>
          </div>

          <div class="mb-3">
            <label class="form-label">Analysis</label>
            <textarea id="caseAnalysis" name="analysis" class="form-control" rows="3"></textarea>
          </div>

          <div class="mb-3">
  <label class="form-label">Video File</label>
  <input type="file" id="caseVideo" name="video" class="form-control">
</div>


          <div class="mb-3">
            <label class="form-label">Video URL</label>
            <input type="text" id="caseVideoUrl" name="video_url" class="form-control">
          </div>

          <div class="mb-3">
            <label class="form-label">Attachment</label>
            <input type="file" id="caseAttachment" name="attachment" class="form-control">
          </div>

        </div>

        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" class="btn btn-primary">Save</button>
        </div>

      </form>

    </div>
  </div>
</div>

<button class="btn btn-success mb-2" id="openAddCaseBtn">+ Add Case Study</button>


        </div>

        <div class="modal-footer">
          <button class="btn btn-secondary" id="prevLectureBtn">Previous</button>
          <button class="btn btn-secondary" id="nextLectureBtn">Next</button>

          <div class="ms-auto">
            <a id="editLectureBtn" class="btn btn-warning" role="button" data-lecture-id="" data-lecture-type="">Edit</a>
            <a id="deleteLectureBtn" class="btn btn-danger" role="button" data-lecture-id="" data-lecture-type="">Delete</a>
            <button class="btn btn-primary" id="openAddQuizBtn" hidden>Add Quiz</button>
          </div>
        </div>

      </div>
    </div>
  </div>
<!-- Case Study Details Modal -->
<div class="modal fade" id="caseDetailsModal" tabindex="-1">
  <div class="modal-dialog modal-lg modal-dialog-centered">
    <div class="modal-content">

      <div class="modal-header">
        <h5 class="modal-title">Case Study Details</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>

      <div class="modal-body">

        <h5 id="detailTitle"></h5>
        <p><strong>Symptoms:</strong></p>
        <p id="detailSymptoms"></p>

        <p><strong>Analysis:</strong></p>
        <p id="detailAnalysis"></p>

        <p><strong>Video URL:</strong></p>
        <p><a id="detailVideoUrl" href="#" target="_blank"></a></p>

      </div>

      <div class="modal-footer">
        <button id="editCaseBtn" class="btn btn-warning">Edit</button>
        <button id="deleteCaseBtn" class="btn btn-danger">Delete</button>
        <button class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
      </div>

    </div>
  </div>
</div>

 <!-- Quiz Detail Modal -->
<div class="modal fade" id="quizDetailModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="quizDetailTitle"></h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <h6>Questions</h6>
        <ul id="quizQuestionsList" class="list-group mb-3"></ul>

        <!-- Add/Edit Question Area (Edit modal) -->
        <div id="quizEditQuestionArea" style="margin-top:20px; display:none;">
          <h6>Add/Edit Question</h6>
          <input type="text" id="editQuestionText" class="form-control mb-2" placeholder="Question text">
          <input type="text" id="edit_option1" class="form-control mb-1" placeholder="Option A">
          <input type="text" id="edit_option2" class="form-control mb-1" placeholder="Option B">
          <input type="text" id="edit_option3" class="form-control mb-1" placeholder="Option C">
          <input type="text" id="edit_option4" class="form-control mb-1" placeholder="Option D">
          <select id="edit_correctAnswer" class="form-select mt-2">
            <option value="1">Correct Answer: A</option>
            <option value="2">Correct Answer: B</option>
            <option value="3">Correct Answer: C</option>
            <option value="4">Correct Answer: D</option>
          </select>
          <button class="btn btn-primary mt-2" id="saveQuizQuestionBtn">Save Question</button>
          <button class="btn btn-secondary mt-2" id="cancelQuizQuestionBtn">Cancel</button>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-danger" id="deleteQuizBtn">Delete Quiz</button>
        <button class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>

  <!-- Edit Lecture Modal -->
<div class="modal fade" id="editLectureModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-centered">
    <div class="modal-content">
      <form id="editLectureForm" enctype="multipart/form-data">
        {% csrf_token %}
        <div class="modal-header">
          <h5 class="modal-title">Edit Lecture</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <input type="hidden" name="lecture_id" id="editLectureId">
          <div class="mb-3">
            <label class="form-label">Title</label>
            <input type="text" name="title" id="editLectureTitle" class="form-control" required>
          </div>
          <div class="mb-3">
            <label class="form-label">Description</label>
            <textarea name="description" id="editLectureDescription" class="form-control"></textarea>
          </div>
          <div class="mb-3">
            <label class="form-label">Order</label>
            <input type="number" name="order" id="editLectureOrder" class="form-control">
          </div>
          <div class="mb-3">
            <label class="form-label">Video file (optional)</label>
            <input type="file" name="video_file" id="editLectureVideo" class="form-control">
          </div>

          <div class="mb-3" id="editDisciplineWrap" style="display:none;">
            <label class="form-label">Discipline</label>
            <select name="discipline" id="editLectureDiscipline" class="form-select">
              <option value="">-- none --</option>
              {% for d in module.basic_system.disciplines.all %}
                <option value="{{ d.id }}">{{ d.get_name_display }}</option>
              {% endfor %}
            </select>
          </div>

        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" class="btn btn-primary">Save changes</button>
        </div>
      </form>
    </div>
  </div>
</div>
{# jQuery, jQuery UI and any other libs already included in your base — include if needed #}
<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
<script src="https://code.jquery.com/ui/1.13.2/jquery-ui.min.js"></script>
<link rel="stylesheet" href="https://code.jquery.com/ui/1.13.2/themes/base/jquery-ui.css">
<script src="{% static 'js/model_details_edit.js' %}"></script>


{% endblock %}
